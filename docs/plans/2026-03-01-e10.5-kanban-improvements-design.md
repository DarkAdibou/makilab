# E10.5 — Kanban Improvements + Activity Log + Chat UX

## Contexte

E10 a livré un Kanban basique (4 colonnes, drag-and-drop, création simple). Cette itération enrichit le dashboard avec CRUD complet, tags, filtres, journal d'activité et streaming chat amélioré.

## A. Kanban CRUD + Tags + Filtres

### Migration DB

Nouvelle migration `tasks_add_description_tags` :
- `description TEXT DEFAULT ''` — description libre de la tâche
- `tags TEXT DEFAULT '[]'` — array JSON de strings (ex: `["dev", "urgent"]`)

Pattern : table `_migrations`, ALTER TABLE rename→recreate→copy→drop.

### API

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| `PATCH` | `/api/tasks/:id` | Enrichir : accepter `description`, `tags`, `due_at` |
| `DELETE` | `/api/tasks/:id` | Supprimer une tâche |
| `GET` | `/api/tasks/tags` | Liste des tags uniques (autocomplétion) |
| `GET` | `/api/tasks` | Ajouter query params `tag`, `priority`, `search` |

### Frontend

- **TaskCard** : description preview (1 ligne tronquée), tags comme badges colorés, icône si `due_at`
- **TaskDetailPanel** : panneau slide-in droit au clic sur une carte
  - Édition inline : titre, description (textarea), priorité (select), tags (input + autocomplétion), échéance (date picker natif)
  - Bouton supprimer avec confirmation
  - Sauvegarde sur blur/entrée
- **FilterBar** : au-dessus du board
  - Chips de filtres (tags sélectionnés, priorité)
  - Barre de recherche texte (filtre client-side)
- **NewTaskModal** : ajouter champs description, tags, due_at

### Tags

- Stockés en JSON : `["urgent", "dev", "perso"]`
- Couleur déterminée par hash du nom → palette de 8 couleurs prédéfinies
- Pas de gestion de couleurs custom (YAGNI)

## B. Journal d'activité agent

### Migration DB

```sql
CREATE TABLE agent_events (
  id          INTEGER PRIMARY KEY AUTOINCREMENT,
  type        TEXT NOT NULL CHECK(type IN ('tool_call','tool_result','message','error')),
  channel     TEXT NOT NULL,
  subagent    TEXT,
  action      TEXT,
  input       TEXT,
  output      TEXT,
  success     INTEGER,
  duration_ms INTEGER,
  created_at  TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX idx_agent_events_created ON agent_events(created_at DESC);
CREATE INDEX idx_agent_events_type ON agent_events(type, created_at DESC);
```

### API

| Méthode | Endpoint | Description |
|---------|----------|-------------|
| `GET` | `/api/activity` | Liste paginée, query params `limit`, `channel`, `type` |

### Instrumentation

Ajouter `logEvent()` dans `agent-loop-stream.ts` à chaque `tool_start` et `tool_end`.

### Frontend

- Page `/activity` dans la sidebar (section OVERVIEW)
- Timeline verticale avec icônes par type
- Timestamps relatifs ("il y a 3 min")
- Détails dépliables (input/output JSON)
- Filtres par type et channel

## C. Chat streaming enrichi

### Backend

Enrichir les events SSE existants dans `agent-loop-stream.ts` :
- `tool_start` → ajouter champ `args` (input JSON)
- `tool_end` → ajouter champ `result` (output résumé, max 200 chars)
- Nouveau type `text_delta` → envoie chaque chunk de texte individuellement (streaming token par token)

### Frontend

- Tokens apparaissent mot par mot (accumulation progressive dans la bulle)
- Tool calls : bloc dépliable inline dans le flux du chat
  - Header : icône + nom du subagent/action
  - Contenu : args formatés + résultat (quand disponible)
  - Spinner pendant l'exécution
- Suppression du simple indicateur "..." actuel

## Ordre d'implémentation

1. Migration DB (description, tags, agent_events)
2. API endpoints (CRUD tasks enrichi, tags, activity, DELETE)
3. Chat streaming enrichi (backend events)
4. Frontend Kanban (TaskDetailPanel, FilterBar, NewTaskModal enrichi, TaskCard enrichi)
5. Frontend Activity page
6. Frontend Chat UX (text_delta streaming, tool call blocks)
7. Tests + polish
