# E4.5 Hardening Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Rendre le codebase production-ready avant E6 : logging structur√© Pino, validation config au boot, et 5 tests Vitest sur les fonctions critiques.

**Architecture:** Trois am√©liorations orthogonales sans refactoring de l'existant. (1) Pino remplace tous les `console.log/error` dans `agent-loop.ts` et `fact-extractor.ts` ‚Äî un logger singleton partag√©. (2) La validation config ajoute une fonction `validateConfig()` appel√©e au boot qui logue et exit proprement si une env var critique manque. (3) Vitest avec 5 tests cibl√©s sur les fonctions pures et critiques ‚Äî pas de TDD r√©troactif global.

**Tech Stack:** Pino (d√©j√† dispo dans le workspace WhatsApp), Vitest, TypeScript strict, Node.js 24.

---

## Contexte codebase

Fichiers cl√©s :
- `packages/agent/src/agent-loop.ts` ‚Äî `console.log` lignes 126, 212, 265 + `console.error` ligne 129
- `packages/agent/src/memory/fact-extractor.ts` ‚Äî `console.log` ligne 90 + `console.error` ligne 94
- `packages/agent/src/index.ts` ‚Äî tous les `console.log` de l'entrypoint (smoke test)
- `packages/agent/src/config.ts` ‚Äî `required()` et `optional()`, objet `config`
- `packages/agent/src/subagents/obsidian.ts` ‚Äî `encodePath()` ligne 184
- `packages/agent/src/memory/fact-extractor.ts` ‚Äî `extractAndSaveFacts()` + JSON parsing
- `packages/agent/src/subagents/registry.ts` ‚Äî `buildCapabilitiesPrompt()`
- `packages/agent/package.json` ‚Äî pas encore de Vitest ni Pino

Pino est disponible dans le workspace :
```bash
ls node_modules/.pnpm/ | grep pino  # v√©rifier si d√©j√† install√©
```

---

## Task 1 : Installer Pino + Vitest dans @makilab/agent

**Files:**
- Modify: `packages/agent/package.json`

**Step 1: Ajouter les d√©pendances**

```bash
cd "d:/SynologyDrive/IA et agents/makilab"
pnpm --filter @makilab/agent add pino
pnpm --filter @makilab/agent add -D vitest @types/node
```

**Step 2: Ajouter le script test dans package.json**

Apr√®s `"typecheck": "tsc --noEmit"`, ajouter :

```json
"test": "vitest run",
"test:watch": "vitest"
```

**Step 3: V√©rifier l'installation**

```bash
pnpm --filter @makilab/agent exec vitest --version
pnpm --filter @makilab/agent exec node -e "import('pino').then(m => console.log('pino ok', m.default.version))"
```

Expected: version de vitest + "pino ok 9.x.x"

**Step 4: Commit**

```bash
cd "d:/SynologyDrive/IA et agents/makilab"
git add packages/agent/package.json pnpm-lock.yaml
git commit -m "chore(E4.5): add pino + vitest to @makilab/agent"
```

---

## Task 2 : Cr√©er le logger Pino singleton

**Files:**
- Create: `packages/agent/src/logger.ts`

**Step 1: Cr√©er le fichier logger.ts**

```typescript
/**
 * logger.ts ‚Äî Structured logger (Pino)
 *
 * Single logger instance for the agent package.
 * In development: pretty-printed with colors (pino-pretty via transport)
 * In production: JSON lines to stdout (structured, parseable by CasaOS/Docker)
 *
 * Usage:
 *   import { logger } from './logger.ts';
 *   logger.info({ channel: 'cli' }, 'Agent started');
 *   logger.error({ err }, 'Something failed');
 */

import pino from 'pino';

const isDev = (process.env['NODE_ENV'] ?? 'development') === 'development';

export const logger = pino({
  level: process.env['LOG_LEVEL'] ?? 'info',
  ...(isDev
    ? {
        transport: {
          target: 'pino/file',
          options: { destination: 1 }, // stdout, human-readable in dev
        },
        // Simple dev format without pino-pretty dep
      }
    : {}),
  base: { service: 'makilab-agent' },
  timestamp: pino.stdTimeFunctions.isoTime,
});
```

Note : on n'utilise pas `pino-pretty` (d√©pendance suppl√©mentaire). En dev, la sortie JSON reste lisible. En prod NUC, c'est exactement ce qu'on veut pour Docker logs.

**Step 2: V√©rifier TypeScript**

```bash
cd "d:/SynologyDrive/IA et agents/makilab"
pnpm --filter @makilab/agent exec tsc --noEmit
```

Expected: aucune erreur.

**Step 3: Commit**

```bash
git add packages/agent/src/logger.ts
git commit -m "feat(E4.5): pino logger singleton"
```

---

## Task 3 : Remplacer console.log dans agent-loop.ts

**Files:**
- Modify: `packages/agent/src/agent-loop.ts`

Les `console.log/error` √† remplacer dans agent-loop.ts :
- Ligne ~126 : `console.log(`üóúÔ∏è  Compaction [${channel}]...`)`
- Ligne ~129 : `console.error('‚ö†Ô∏è  Compaction failed:', ...)`
- Ligne ~212 : `console.log(`üîß [${subagentName}/${actionName}]`)`

**Step 1: Ajouter l'import logger en haut du fichier**

Apr√®s les imports existants (apr√®s `import type { AgentContext }`), ajouter :

```typescript
import { logger } from './logger.ts';
```

**Step 2: Remplacer les console.log dans compactHistory()**

Remplacer :
```typescript
console.log(`üóúÔ∏è  Compaction [${channel}]: ${toCompact} messages ‚Üí r√©sum√©`);
```
Par :
```typescript
logger.info({ channel, compacted: toCompact }, 'History compacted');
```

Remplacer :
```typescript
console.error('‚ö†Ô∏è  Compaction failed:', err instanceof Error ? err.message : err);
```
Par :
```typescript
logger.error({ err: err instanceof Error ? err.message : String(err) }, 'Compaction failed');
```

**Step 3: Remplacer le console.log dans la boucle agentique**

Remplacer :
```typescript
console.log(`üîß [${subagentName}/${actionName}]`);
```
Par :
```typescript
logger.info({ subagent: subagentName, action: actionName }, 'Subagent call');
```

**Step 4: V√©rifier TypeScript**

```bash
pnpm --filter @makilab/agent exec tsc --noEmit
```

Expected: aucune erreur.

**Step 5: Commit**

```bash
git add packages/agent/src/agent-loop.ts
git commit -m "feat(E4.5): replace console.log with pino in agent-loop"
```

---

## Task 4 : Remplacer console.log dans fact-extractor.ts

**Files:**
- Modify: `packages/agent/src/memory/fact-extractor.ts`

Les `console.log/error` √† remplacer :
- Ligne ~90 : `console.log(`üß† ${count} fait(s)...`)`
- Ligne ~94 : `console.error('‚ö†Ô∏è  Fact extraction failed...')`

**Step 1: Ajouter l'import logger**

```typescript
import { logger } from '../logger.ts';
```

**Step 2: Remplacer les console calls**

Remplacer :
```typescript
console.log(`üß† ${count} fait(s) extrait(s) depuis [${channel}]`);
```
Par :
```typescript
logger.info({ channel, count }, 'Facts extracted');
```

Remplacer :
```typescript
console.error('‚ö†Ô∏è  Fact extraction failed (non-critical):', err instanceof Error ? err.message : err);
```
Par :
```typescript
logger.warn({ err: err instanceof Error ? err.message : String(err) }, 'Fact extraction failed (non-critical)');
```

**Step 3: V√©rifier TypeScript**

```bash
pnpm --filter @makilab/agent exec tsc --noEmit
```

**Step 4: Commit**

```bash
git add packages/agent/src/memory/fact-extractor.ts
git commit -m "feat(E4.5): replace console.log with pino in fact-extractor"
```

---

## Task 5 : Ajouter validateConfig() dans config.ts

**Files:**
- Modify: `packages/agent/src/config.ts`

La validation actuelle (`required()`) throw au moment de l'import du module ‚Äî ce qui est opaque. On ajoute une fonction `validateConfig()` qui logue clairement ce qui manque et exit proprement.

**Step 1: Ajouter l'import et la fonction validateConfig √† la fin de config.ts**

```typescript
import { logger } from './logger.ts';

/**
 * Call at boot to validate all required env vars.
 * Logs clearly which vars are missing and exits with code 1.
 * Optional vars missing are logged as warnings.
 */
export function validateConfig(): void {
  const missing: string[] = [];

  // Required ‚Äî agent cannot start without these
  if (!process.env['ANTHROPIC_API_KEY']) missing.push('ANTHROPIC_API_KEY');
  if (!process.env['WHATSAPP_ALLOWED_NUMBER']) missing.push('WHATSAPP_ALLOWED_NUMBER');

  if (missing.length > 0) {
    logger.fatal({ missing }, 'Missing required env vars ‚Äî cannot start');
    process.exit(1);
  }

  // Optional ‚Äî warn if missing (subagents will be degraded)
  const optionalWarnings: string[] = [];
  if (!process.env['OBSIDIAN_VAULT_PATH']) optionalWarnings.push('OBSIDIAN_VAULT_PATH (obsidian fallback disabled)');
  if (!process.env['OBSIDIAN_REST_API_KEY']) optionalWarnings.push('OBSIDIAN_REST_API_KEY (obsidian REST disabled)');
  if (!process.env['BRAVE_SEARCH_API_KEY']) optionalWarnings.push('BRAVE_SEARCH_API_KEY (web search disabled)');
  if (!process.env['KARAKEEP_API_KEY']) optionalWarnings.push('KARAKEEP_API_KEY (karakeep disabled)');

  for (const w of optionalWarnings) {
    logger.warn({ missing: w }, 'Optional env var not set');
  }

  logger.info({ env: config.nodeEnv }, 'Config validated');
}
```

**Step 2: Appeler validateConfig() dans index.ts au boot**

Dans `packages/agent/src/index.ts`, apr√®s les imports, ajouter en premier :

```typescript
import { validateConfig } from './config.ts';
validateConfig();
```

**Step 3: V√©rifier TypeScript**

```bash
pnpm --filter @makilab/agent exec tsc --noEmit
```

**Step 4: V√©rifier que le boot logge correctement**

```bash
cd "d:/SynologyDrive/IA et agents/makilab" && pnpm dev:agent 2>&1 | head -20
```

Expected : lignes JSON avec `"msg":"Optional env var not set"` pour BRAVE et KARAKEEP, puis `"msg":"Config validated"`.

**Step 5: Commit**

```bash
git add packages/agent/src/config.ts packages/agent/src/index.ts
git commit -m "feat(E4.5): validateConfig() ‚Äî structured boot validation with pino"
```

---

## Task 6 : √âcrire les 5 tests Vitest

**Files:**
- Create: `packages/agent/src/tests/hardening.test.ts`

Les 5 tests cibl√©s (fonctions pures, pas de mocks Anthropic) :

**Test 1 ‚Äî encodePath** : encode les segments mais pr√©serve les `/`
**Test 2 ‚Äî buildCapabilitiesPrompt** : retourne une string avec tous les subagents
**Test 3 ‚Äî fact-extractor JSON strip** : strip les fences markdown avant JSON.parse
**Test 4 ‚Äî capture ROUTING_MAP** : tous les CaptureType ont une entr√©e dans le map
**Test 5 ‚Äî config optional fallback** : `optional()` retourne le fallback si env var absente

**Step 1: Cr√©er le fichier de tests**

```typescript
/**
 * hardening.test.ts ‚Äî Tests critiques E4.5
 *
 * Couvre les fonctions pures et critiques du codebase.
 * Pas de mocks Anthropic (trop co√ªteux √† maintenir).
 * Focus sur les bugs qui ont d√©j√† caus√© des probl√®mes.
 */

import { describe, it, expect } from 'vitest';

// ‚îÄ‚îÄ Test 1 : encodePath ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Bug historique : encodeURIComponent('Captures/URLs/test.md') ‚Üí 'Captures%2FURLs%2Ftest.md'
// Fix : encoder chaque segment s√©par√©ment
describe('encodePath', () => {
  function encodePath(path: string): string {
    return path.split('/').map(encodeURIComponent).join('/');
  }

  it('preserves / separators', () => {
    expect(encodePath('Captures/URLs/test.md')).toBe('Captures/URLs/test.md');
  });

  it('encodes spaces in segments', () => {
    expect(encodePath('Captures/My Notes/note.md')).toBe('Captures/My%20Notes/note.md');
  });

  it('encodes special chars in segments', () => {
    expect(encodePath('Notes/R√©union √©quipe.md')).toBe('Notes/R%C3%A9union%20%C3%A9quipe.md');
  });

  it('handles flat path (no slashes)', () => {
    expect(encodePath('simple.md')).toBe('simple.md');
  });
});

// ‚îÄ‚îÄ Test 2 : buildCapabilitiesPrompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
describe('buildCapabilitiesPrompt', () => {
  it('lists all registered subagents', async () => {
    const { buildCapabilitiesPrompt } = await import('../subagents/registry.ts');
    const prompt = buildCapabilitiesPrompt();
    expect(prompt).toContain('obsidian');
    expect(prompt).toContain('capture');
    expect(prompt).toContain('karakeep');
    expect(prompt).toContain('web');
    expect(prompt).toContain('gmail');
    expect(prompt).toContain('time');
  });

  it('includes action descriptions', async () => {
    const { buildCapabilitiesPrompt } = await import('../subagents/registry.ts');
    const prompt = buildCapabilitiesPrompt();
    expect(prompt).toContain('classify');
    expect(prompt).toContain('search');
  });
});

// ‚îÄ‚îÄ Test 3 : JSON fence stripping (fact-extractor pattern) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Bug historique : Haiku retournait JSON envelopp√© dans ```json ... ```
describe('JSON fence stripping', () => {
  function stripFences(raw: string): string {
    return raw.replace(/^```(?:json)?\s*/i, '').replace(/\s*```\s*$/, '').trim();
  }

  it('strips ```json fences', () => {
    const raw = '```json\n{"key": "value"}\n```';
    expect(stripFences(raw)).toBe('{"key": "value"}');
  });

  it('strips ``` fences (no language)', () => {
    const raw = '```\n{"key": "value"}\n```';
    expect(stripFences(raw)).toBe('{"key": "value"}');
  });

  it('leaves plain JSON untouched', () => {
    const raw = '{"key": "value"}';
    expect(stripFences(raw)).toBe('{"key": "value"}');
  });

  it('stripped result is valid JSON', () => {
    const raw = '```json\n{"name": "Adrien", "city": "Sydney"}\n```';
    const stripped = stripFences(raw);
    expect(() => JSON.parse(stripped)).not.toThrow();
    expect(JSON.parse(stripped)).toEqual({ name: 'Adrien', city: 'Sydney' });
  });
});

// ‚îÄ‚îÄ Test 4 : capture ROUTING_MAP coverage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
describe('capture ROUTING_MAP', () => {
  const CAPTURE_TYPES = [
    'company', 'contact', 'url', 'prompt', 'snippet',
    'idea', 'meeting_note', 'task', 'quote', 'unknown',
  ] as const;

  const ROUTING_MAP: Record<string, { destinations: string[]; obsidianFolder: string }> = {
    url:          { destinations: ['karakeep', 'obsidian'], obsidianFolder: 'Captures/URLs' },
    company:      { destinations: ['karakeep', 'obsidian'], obsidianFolder: 'Captures/Companies' },
    contact:      { destinations: ['obsidian'],             obsidianFolder: 'Captures/Contacts' },
    idea:         { destinations: ['obsidian'],             obsidianFolder: 'Captures/Ideas' },
    snippet:      { destinations: ['obsidian'],             obsidianFolder: 'Captures/Snippets' },
    prompt:       { destinations: ['obsidian'],             obsidianFolder: 'Captures/Prompts' },
    meeting_note: { destinations: ['obsidian'],             obsidianFolder: 'Captures/Meetings' },
    task:         { destinations: ['obsidian'],             obsidianFolder: 'Captures/Tasks' },
    quote:        { destinations: ['obsidian'],             obsidianFolder: 'Captures/Quotes' },
    unknown:      { destinations: ['obsidian'],             obsidianFolder: 'Captures/Inbox' },
  };

  it('has an entry for every CaptureType', () => {
    for (const type of CAPTURE_TYPES) {
      expect(ROUTING_MAP[type], `Missing routing for type: ${type}`).toBeDefined();
    }
  });

  it('every entry has obsidian in destinations or as folder', () => {
    for (const [type, routing] of Object.entries(ROUTING_MAP)) {
      expect(routing.obsidianFolder, `Missing obsidianFolder for ${type}`).toBeTruthy();
      expect(routing.destinations.length, `Empty destinations for ${type}`).toBeGreaterThan(0);
    }
  });

  it('url and company route to both karakeep and obsidian', () => {
    expect(ROUTING_MAP['url']!.destinations).toContain('karakeep');
    expect(ROUTING_MAP['company']!.destinations).toContain('karakeep');
  });

  it('unknown routes to obsidian inbox (not karakeep)', () => {
    expect(ROUTING_MAP['unknown']!.destinations).toEqual(['obsidian']);
    expect(ROUTING_MAP['unknown']!.obsidianFolder).toBe('Captures/Inbox');
  });
});

// ‚îÄ‚îÄ Test 5 : buildObsidianPath filename sanitization ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
describe('buildObsidianPath sanitization', () => {
  function sanitizeFilename(title: string): string {
    return title.replace(/[/\\:*?"<>|]/g, '-').substring(0, 60);
  }

  it('replaces forbidden chars with dashes', () => {
    expect(sanitizeFilename('Note: with/slashes and *stars*')).toBe('Note- with-slashes and -stars-');
  });

  it('truncates long titles to 60 chars', () => {
    const long = 'A'.repeat(100);
    expect(sanitizeFilename(long)).toHaveLength(60);
  });

  it('leaves normal title unchanged', () => {
    expect(sanitizeFilename('OpenAI Function Calling Documentation')).toBe('OpenAI Function Calling Documentation');
  });
});
```

**Step 2: Lancer les tests pour v√©rifier qu'ils passent**

```bash
cd "d:/SynologyDrive/IA et agents/makilab"
pnpm --filter @makilab/agent test
```

Expected :
```
‚úì hardening.test.ts (14 tests)
  ‚úì encodePath (4)
  ‚úì buildCapabilitiesPrompt (2)
  ‚úì JSON fence stripping (4)
  ‚úì capture ROUTING_MAP (4)
  ‚úì buildObsidianPath sanitization (3)

Test Files  1 passed (1)
Tests       14 passed (14)
```

**Step 3: Si des tests √©chouent, d√©boguer et corriger**

Les tests les plus susceptibles d'√©chouer :
- `buildCapabilitiesPrompt` : import dynamique peut avoir des soucis avec tsx/esm ‚Üí si √ßa √©choue, mocker le registry
- `unknown routes to obsidian inbox` : v√©rifier que le ROUTING_MAP local dans le test correspond bien √† capture.ts

**Step 4: Ajouter le script test dans la CI**

Dans `packages/agent/package.json`, v√©rifier que `"test": "vitest run"` est bien pr√©sent (Task 1).

**Step 5: Commit**

```bash
git add packages/agent/src/tests/hardening.test.ts
git commit -m "test(E4.5): 14 tests Vitest ‚Äî encodePath, routing, JSON strip, capabilities"
```

---

## Task 7 : Smoke test complet + push

**Step 1: V√©rifier que tout compile**

```bash
cd "d:/SynologyDrive/IA et agents/makilab"
pnpm --filter @makilab/agent exec tsc --noEmit
```

**Step 2: Lancer les tests**

```bash
pnpm --filter @makilab/agent test
```

Expected: 14 tests passent.

**Step 3: Lancer l'agent**

```bash
pnpm dev:agent 2>&1 | head -30
```

Expected : output JSON structur√© Pino avec les warnings optional env vars + "Config validated".

**Step 4: Mettre √† jour PROGRESS.md**

Ajouter une section `## E4.5 ‚Äî Hardening` avec les stories :
- L4.5.1 Pino logger singleton ‚úÖ
- L4.5.2 validateConfig() au boot ‚úÖ
- L4.5.3 14 tests Vitest (encodePath, routing, JSON strip, capabilities) ‚úÖ

**Step 5: Push**

```bash
git add PROGRESS.md
git commit -m "chore: PROGRESS.md ‚Äî E4.5 Hardening termin√© ‚úÖ"
git push origin master
```

---

## R√©sum√© des fichiers touch√©s

| Fichier | Action | Raison |
|---------|--------|--------|
| `packages/agent/package.json` | Modify | Ajouter pino + vitest + script test |
| `packages/agent/src/logger.ts` | Create | Logger Pino singleton |
| `packages/agent/src/agent-loop.ts` | Modify | Remplacer console.log/error par logger |
| `packages/agent/src/memory/fact-extractor.ts` | Modify | Remplacer console.log/error par logger |
| `packages/agent/src/config.ts` | Modify | Ajouter validateConfig() |
| `packages/agent/src/index.ts` | Modify | Appeler validateConfig() au boot |
| `packages/agent/src/tests/hardening.test.ts` | Create | 14 tests Vitest |
| `PROGRESS.md` | Modify | Section E4.5 |

## Ce que E4.5 ne fait PAS (YAGNI)

- Pas de pino-pretty (d√©pendance dev suppl√©mentaire ‚Äî les JSON sont lisibles en dev)
- Pas de log rotation (g√©r√© par Docker/CasaOS en prod)
- Pas de tests d'int√©gration avec mock Anthropic (trop co√ªteux √† maintenir)
- Pas de retry/circuit-breaker (E6)
- Pas de permission check (E6 avec PostgreSQL)
- Pas de logging dans les subagents individuels (ils retournent SubAgentResult, le loop logue)
